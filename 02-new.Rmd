# 第三章 数据整理


数据整理（Data wrangling）是指对原始数据进行一系列的处理，以消除数据中错误，选择合适的数据，调整数据格式，为后续的探索性数据分析做好准备。数据加工主要包括数据清理（Data Cleaning）、变量筛选、数据合成（Data Integration）、数据塑形（Data reshaping）等。在学习数据处理之前，我们需要对数据与变量的类型有所了解。

## 数据与变量

### 结构型数据和非结构型数据
根据数据的组织方式，数据科学中将数据分为结构型数据（Structured Data）和非结构型数据（Unstructured Data）。

结构型数据是指以明确定义的数据结构和数据模式组织的数据，其数据元素之间存在预定义的关系和属性，以便于存储、检索和分析。结构型数据具有固定的格式和字段，通常以表格、数据库、CSV（逗号分隔值）文件等形式存储。每个数据项都有预定义的类型，例如整数、浮点数、日期、文本等，且数据之间可以通过键值或主键进行关联。

非结构型数据是指没有固定格式和明确定义的数据，数据元素之间缺乏预定义的关系和属性，不易于直接存储和分析的数据形式。常见的非结构型数据有文本、图像、音频、视频等内容，其结构和含义需要进一步的处理和解析。这些数据通常存储在文档、图像文件、日志、社交媒体帖子等中。
示例：

- 文本数据：社交媒体帖子、新闻文章、电子邮件等。
- 图像数据：照片、绘画、图表等。
- 音频数据：录音、音乐等。

在语言研究中，语言本体数据包括文本数据（含口语转录的文本）和语音数据。语言使用者的社会人口学数据也是语言研究的重要组成部分。在实验语言学或心理语言学研究中，数据还包括语言使用者加工语言的行为数据和神经活动数据。语言研究涉及的数据类型十分丰富，同时也为数据处理提出了巨大的挑战。

语言研究中，实验数据通常是结构性的。语音数据及标注，还有相应的声学指标，如时长，元音的共振峰，响音部分的基频等一般也是以结构性数据形式存在。结构化数据是较为容易存储，处理的。

文本数据比如博客，文章，小说等是非结构化的，不能直接用数据科学中的数据探索分析方法或者数据建模和数据可视化。文本数据可以通过分词，词频统计，特征提取等方法转化为结构性数据。只有当转化为结构性数据之后，进一步加入元数据，我们才能够来讨论变量之间的关系。在语言研究中，语料库数据通常是非结构性的，对语料库进行量化分析需要我们提取相应信息并转化成为结构性的数据。


### 质性数据和量化数据

根据数据的统计学特性，数据可以分为质性数据和量化数据。质性数据是指不能够用数字来表示，也不能够进行简单的数学计算，而仅仅用来描述某个事物的范畴属性。比如，语音学中一个音是元音，还是辅音。一个词的词性，名词，动词。一句话所具有的语用功能。

量化数据是可以用数字来描述并且可以进行简单的数学运算。进一步可以分为离散数据（Discrete）和连续数据（ Continuous）。离散数据只能用某一些数值代表，比如参与实验的人数，实验中刺激的个数。连续数据（ Continuous）可以有无限的数据数值代表，比如实验任务的反应时。

在科学研究中，为了探究一些问题，我们通过实验、调查、观察或其他数据收集方法获得的数据。数据通常用于描述和分析研究中的变量，并用于回答研究问题或测试假设。数据是对变量的测量或观察结果。

### 变量

变量是指任何可以被测量或计数的特征，用于描述不同个体或实物的特征，比如年龄、性别、企业收入和支出、出生国家、班级成绩、眼睛颜色和车辆类型都是常见的变量。变量之所以称为变量，是因为在一个总体（population）或数据集中，其值可能会在不同的个体之间有所变化，或者随着时间的推移可能会发生变化。例如，一个人的身高可以随着时间的推移而增长，一个企业的收入和支出可以随着季度或年份的变化而变化。

变量根据其描述性统计特性分为四种不同层次，分别为定类（nominal）、定序(ordinal)、定距（interval）及定比（ratio）变量。同时，定类和定序变量为类别变量（categorical），定距和定比变量为数值变量（numberic）。

### 类别变量
定性变量描述事物的“特征”、“类型”或“范畴”，通常使用非数字值表示。分类变量通常是排他的性，即一个个体属于同一变量中的一个类别。分类变量应该是详尽的，包括所有可能的类别。

类别变量可以进一步分为定类和定序两种。定类变量描述一个类别，无法按逻辑顺序进行组织。常见的该类变量包括性别、企业类型、眼睛颜色、宗教和品牌。我们可以描述其频数（率），或者一组数据中的众数 （出现频数最高的）。
定序变量描述一个有顺序类别。比如，调查问卷中，喜欢、一般、厌恶，这3个选项就构成了有顺序数据。定序数据可以按数据顺序排列，因此除了众数之外，我们还可以描述其中位数，也就是将一组数据按一定顺序排列，其中处于中间位置的数据。定序变量的类别相互比较高低大小，但不一定能建立各个类别之间的数字差异。换句话说，变量水平之间的间隔是未知的。

在一些情况下，我们可以为有序变量的不同水平分配数字，实现定序变量转化为数值变量，但我们需要注意这些变量不是数值型的。例如，“非常同意”和“中立”不能平均为“同意”，即使我们将“非常同意”分配为5，将“中立”分配为3。


### 数值型变量

数值型变量描述了一个可测量的数量，其中数字之间的间隔是相等的。比如，1千克和2千克之间的间隔与3千克和4千克之间的间隔相等。
定距数据是一种数值性变量，一种具有等距间隔的变量，其中相邻数值之间的差异是相等的。比如气温。定距数据可以进行加减。
定比数据和定距数据的区别在于，定比数据有一个零点。比如，年龄、体重、身高都属于定比数据，不存在负值。定比数据除了可以加减运算以外，还可以乘除运算。我们可以说一个人的年龄是另外一个人的两倍。

数值型变量可以进一步分为连续（continuous）变量和离散（discrete）变量两个子类。

离散变量由整数值组成，不能取介于两个值之间的值。常见的离散变量有：车辆数量、家庭子女数量。它们都以整数单位衡量。

连续变量可以取一定集合范围内任意一个值。连续变量的观测值可以包括仪器测量允许的最小值。连续变量的例子包括身高、时间、年龄和温度。


变量类型将决定（1）统计分析的方法；（2）我们如何使用统计数据和图表总结数据。

| 数据层级 | 趋中性描述        | 变异性描述     | 数学运算      | 举例             |
| ---- | ------------ | --------- | --------- | -------------- |
| 定类   | 众数           | 不能        | 是否相等，集合关系 | 实验反应选项、词性、语音类别 |
| 定序   | 众数、中位数       | 不能        | 排序、比较     | 李克特量表问题数据      |
| 定距   | 众数、中位数、算数平均值 | 极差、方差、标准差 | 加减        | 温度     |
| 定比   | 众数、中位数、几何平均值 | 极差、方差、标准差 | 乘除        | 年龄、体重、身高               |


不同的变量需要以不同的数据类型存储在R中。名义变量和定序变量可以存储为字符类型（character）或因子（factors，具有级别）。数值型数据存储为数字，可以是整数（integer）、实数（real）、小数（decimal）。一个数据集（dataset）可以包含一个或者多个变量，这些变量可能有一种或者多种不同的类型。



## 数据清洁
数据清理（Data Cleaning）是数据科学和数据分析中的重要步骤，指的是对原始数据进行检查或修正，处理数据中的错误、缺失、异常和重复值等问题，从而得到干净、可靠的数据集，使数据更适合后续的分析和建模工作。



```{r }

library(tidyverse)
# 创建含有错误值的数据
set.seed(123)  # 设置随机种子以确保可重复性
df_errors <- data.frame(Student_ID = 1:100,
                    Listening_Score = sample(-5:100, 100, replace = TRUE),
                    Speaking_Score = sample(0:999, 100, replace = TRUE),
                    Reading_Score = sample(0:105, 100, replace = TRUE),
                    Writing_Score = sample(0:100, 100, replace = TRUE),
                    Age = sample(c(18:40, NA), 100, replace = TRUE),
                    Gender = sample(c("Male", "Female"), 100, replace = TRUE))
```




### 任务-处理异常值
> 异常值是指与其他观测值明显不同的异常点，可能是数据录入错误或者异常情况。可以选择删除异常值或者采用合适的方法进行处理。

- 筛除学生听力分数小于0的数据。
- 筛除学生阅读分数超过满分100分的数据。
- 筛除年龄缺失的数据


```{r }

df.clean = df_errors %>% 
  filter(Listening_Score > 0 | Reading_Score < 100)%>%
  filter(!is.na(Age))

```

## 变量筛选

当变量过多时，我们可以选择部分变量组成新的数据框。

### 任务-变量筛选

- 选择所有女生的听力数据

- 选择所有男生的阅读数据

```{r }

df.girl = df_errors %>% 
  filter(Gender == "Female")%>%
  select(Listening_Score)


df.boy = df_errors %>% 
  filter(Gender == "Male")%>%
  select(Reading_Score)

```


## 数据塑形

数据重塑（Data Reshaping）是指将原始数据在行和列之间进行转换，从而改变数据的排列方式，以便于进行特定的数据分析或建模。tidyr是一个常用的数据整理包，主要用于处理数据的宽格式和长格式之间的转换。
Tidy data（整洁数据）是Hadley Wickham在2014年提出的一种数据组织原则，其目标是使数据集易于分析、可读性强，并且方便进行数据操作和可视化。在整洁数据中，每个变量都是一个列，每个观察值都是一个行，每个数据集都是一个表格。整洁数据遵循三个基本规则：


例子：学生考试成绩数据集

|Student|Subject|Score|
|:----|:----|:----|
|Alice|Math|85|
|Alice|English|78|
|Bob|Math|92|
|Bob|English|88|


在上面的例子中，每个变量都在数据集的一列中表示（例如，学生、科目、分数在学生考试成绩数据集中是列名），每个观察值在数据集的一行中表示（例如，每个学生的考试成绩是一行）。又称为长数据（Long data）。

相对而言，宽数据（Wide data）中每一行代表一个观察单元，不同属性或测量结果被放置在同一行的不同列中。
如下：

| 学生姓名 | 数学成绩 | 英语成绩 |
|---------|----------|---------|
| Alice   | 85       | 78      |
| Bob     | 92       | 88      |

长数据和宽数据的选择取决于具体的数据分析需求和使用场景。在某些情况下，长数据更适合进行数据处理和可视化，而在其他情况下，宽数据更便于进行数据呈现。它们可以相互转换。

```{r }
# 生成一个二语学术写作数据集
set.seed(123)  # 设置随机种子，以确保结果可复现

academic_writing_data <- tibble(
  student_id = 1:50,  # 学生ID
  native_language = sample(c("Chinese", "Spanish", "French", "Russian", "German", "Italian"), 50, replace = TRUE),  # 母语
  second_language = sample(c("English", "Chinese", "Spanish", "French", "German", "Italian"), 50, replace = TRUE),  # 二语
  essay1_length = sample(200:2000, 50, replace = TRUE),  # 论文1长度
  essay2_length = sample(200:2000, 50, replace = TRUE),  # 论文2长度
  essay3_length = sample(200:2000, 50, replace = TRUE),  # 论文3长度
  academic_performance = sample(60:100, 50, replace = TRUE),  # 学术成绩
  writing_speed = sample(200:800, 50, replace = TRUE),  # 写作速度（单词/分钟）
  language_anxiety = sample(1:5, 50, replace = TRUE),  # 语言焦虑水平（1-5分）
  writing_errors = sample(0:30, 50, replace = TRUE),  # 写作错误数
  research_experience = sample(c(TRUE, FALSE), 50, replace = TRUE),  # 是否有研究经验
  self_evaluation = sample(c("Excellent", "Good", "Fair", "Poor"), 50, replace = TRUE)  # 自我评价
)
```



### 任务-数据塑形

- 把essay1_length、essay2_length和essay3_length三列汇总到一列中

- 把gathered_data_1转回宽格式



```{r }

# 把essay1_length、essay2_length和essay3_length三列汇总到一列中
gathered_data_1 <- gather(academic_writing_data, essay, length, essay1_length:essay3_length)


# 把gathered_data_1转回宽格式
spreaded_data_1 <- spread(gathered_data_1, essay, length)


```



## 数据整合

如果数据来自不同的源头，可能需要将多个数据集合并成一个整体数据集，进行数据整合和关联分析，即数据整合 （Data Integration）。

我们模拟了以下2个数据集：
- 学生信息数据集（Student_Info）：包含学生ID、性别、年龄等学生信息。
- 语言测试数据集（Language_Test）：包含学生ID、听说读写分数等语言测试结果。
在这里，我们将把不同数据集中的学生ID作为核心进行合并。



### 任务-数据整合
合并学生信息数据集和语言测试数据集，创建一个包含学生信息和语言测试结果的数据集。




```{r }


# 创建学生信息数据集
student_info <- data.frame(Student_ID = 1:100,
                       Gender = sample(c("Male", "Female"), 100, replace = TRUE),
                       Age = sample(18:25, 100, replace = TRUE))

# 创建语言测试数据集
language_test <- data.frame(Student_ID = 1:100,
                        Listening_Score = sample(0:100, 100, replace = TRUE),
                        Speaking_Score = sample(0:100, 100, replace = TRUE),
                        Reading_Score = sample(0:100, 100, replace = TRUE),
                        Writing_Score = sample(0:100, 100, replace = TRUE))

# 使用inner_join函数将学生信息数据集和语言测试数据集合并
merged_data <- inner_join(student_info, language_test, by = "Student_ID")



```


